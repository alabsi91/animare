"use strict";var _easingFunctions=require("./easingFunctions");Object.defineProperty(exports,"__esModule",{value:!0}),exports.animare=animare;function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var isDevMode=!process.env.NODE_ENV||"development"===process.env.NODE_ENV;function animare(a,b){var g,h,i,j,k,l,m,c=Math.abs,f=Math.round;a=null!==(g=a)&&void 0!==g?g:{},a.duration=null!==(h=a.duration)&&void 0!==h?h:350,a.autoPlay=null===(i=a.autoPlay)||void 0===i||i,a.repeat=null!==(j=a.repeat)&&void 0!==j?j:0,a.delay=null!==(k=a.delay)&&void 0!==k?k:0,a.direction=null!==(l=a.direction)&&void 0!==l?l:"normal",a.easingFunction=null!==(m=a.easingFunction)&&void 0!==m?m:_easingFunctions.easing.linear;var n=function(){if("number"!=typeof a.to&&!Array.isArray(a.to))throw new Error("[to] is required");if(Array.isArray(a.to)){if(!a.to.every(function(a){return"number"==typeof a}))throw new Error("[to] must be a number or an array of numbers");}else if("number"!=typeof a.to)throw new Error("[to] must be a number or an array of numbers");if(Array.isArray(a.from)){if(!a.from.every(function(a){return"number"==typeof a}))throw new Error("[from] must be a number or an array of numbers");if(a.from.length!==a.to.length)throw new Error("[from] and [to] must have the same length")}else if(a.from&&"number"!=typeof a.from)throw new Error("[from] must be a number or an array of numbers");if("number"!=typeof a.duration||0>a.duration)throw new Error("[duration] must be a number greater than -1");if("number"!=typeof a.delay||0>a.delay)throw new Error("[delay] must be a number greater than -1");if("number"!=typeof a.repeat)throw new Error("[repeat] must be a number");if("boolean"!=typeof a.autoPlay)throw new Error("[autoPlay] must be a boolean");if(!["normal","reverse","alternate","alternate-reverse"].includes(a.direction))throw new Error("[direction] must be a string and one of the following: normal, reverse, alternate, alternate-reverse");if("string"==typeof a.easingFunction&&!_easingFunctions.easing.hasOwnProperty(a.easingFunction))throw new Error("[easingFunction] must be a string, array of strings, function or array of functions, and for a string value one of the following: "+Object.keys(_easingFunctions.easing).join(", "));Array.isArray(a.easingFunction)&&a.easingFunction.forEach(function(a){if("string"==typeof a&&!_easingFunctions.easing.hasOwnProperty(a))throw new Error("[easingFunction] must be a string, array of strings, function or array of functions, and for a string value one of the following: "+Object.keys(_easingFunctions.easing).join(", "))})};isDevMode&&n(),a.direction.includes("alternate")&&(a.duration/=2);var o=function(a){return new Promise(function(b){return setTimeout(b,a)})},q=null,r=null,s=0,t=1,u=a.repeat,v=1,w=!0,y=!1,z=!0,A=null,B=!1,C=!1,D=null,E=!1,F=!1,G=null,H=null;a.from===void 0&&(a.from=Array.isArray(a.to)?Array(a.to.length).fill(0):0);var I=function(b){var c=b.easingFunction,d=Array.isArray(c),e="function"==typeof c,f=Array.isArray(a.to);d&&f?(a.easingFunction=c.map(function(a){return"string"==typeof a?_easingFunctions.easing[a]:a}),c.length<a.to.length&&(a.easingFunction=c.concat(Array(a.to.length-c.length).fill(_easingFunctions.easing.linear))),a.to.length>c.length&&(c.length=a.to.length)):d&&!f?a.easingFunction="string"==typeof c[0]?_easingFunctions.easing[c[0]]:c[0]:!d&&f?e?a.easingFunction=Array(a.to.length).fill(c):"string"==typeof c&&(a.easingFunction=Array(a.to.length).fill(_easingFunctions.easing[c])):!d&&!f&&(a.easingFunction=e?c:_easingFunctions.easing[c])};I(a);var J=[{options:_objectSpread({},a),cb:b,id:"default",userInput:_objectSpread({},a)}],K=new Set,L=!1,M={repeat:0,speed:1},N=M.repeat,O=new Set,P={onProgress:[],onStart:[],onFinish:[]},Q=function(){if(!(z||B)){if(K.size===J.length)return(K.clear(),O.clear(),E=!1,a=_objectSpread({},J[0].options),b=J[0].cb,0===N)?(N=M.repeat,void(L=!1)):(N=0>N?-1:N-1,void(L?ea():ca()));var c=L?J.length-K.size-1:K.size,d=J[c];a=_objectSpread({},d.options),b=d.cb,u=a.repeat,I(a),K.add(d.id),E=!1,L?a.direction.includes("alternate")?ca():ea():ca()}},R=function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function b(){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(0!==a.repeat){b.next=3;break}return Q(),b.abrupt("return");case 3:if(0!==u){b.next=8;break}return u=a.repeat,F=!1,Q(),b.abrupt("return");case 8:if(0>u&&O.clear(),u=0>u?-1:u-1,!a.delay){b.next=13;break}return b.next=13,o(a.delay);case 13:if(!a.direction.includes("alternate")){b.next=16;break}return X(!0),b.abrupt("return");case 16:E?_():$();case 17:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}(),S=function(a){w=1===v,r=a,W(a,!0),w=!1},T=function(a){K.size!==J.length||(G&&a&&(G(),G=null),0<P.onFinish.length&&P.onFinish.forEach(function(b){var c=b.cb;a&&c()}))},U=function(a,b){if(H){var c=H,d=c.at,e=c.resolve,f=c.atRepeat;if("string"==typeof d){var g=parseInt(d);a>=g&&f===u&&!O.has(a)&&(O.add(a),e(),H=null)}b>=d&&!O.has(b)&&(O.add(b),e(),H=null)}0<P.onProgress.length&&P.onProgress.forEach(function(c){var d=c.at,e=c.cb,f=c.id,g=c.atRepeat;if("string"==typeof d){var h=parseInt(d);a>=h&&g===u&&!O.has(f)&&(e(),O.add(f))}b>=d&&!O.has(f)&&(e(),O.add(f))})},V=function(a,b,c){return Math.max(b,Math.min(c,f(a)))},W=function(c){var g=Number.isNaN;c+=s;var h=(c-r)/a.duration;h=1<=h||g(h)?1:h;var j=a.direction.includes("alternate"),k=K.size-1,l=f(t/((performance.now()-r)/1e3));t+=1;var m=c-r>a.duration?a.duration:f(c-r);m=j&&2===v?m+a.duration:m;var n=j?1===v?h/2:h/2+.5:h;n=V(f(100*n),0,100);var o=n/J.length+100*((K.size-1)/J.length);o=V(o,0,100);for(var A,D=0,E=0;E<K.size-1;E++)A=J[E].options.duration,D=1===K.size?0:D+A;var F=D+m;1<=h&&(y=!j||2===v),C=0===u&&1<=h&&y&&K.size===J.length;var G={isFirstFrame:w,isLastFrame:y,isFinished:C,progress:n,repeatCount:u,alternateCycle:v,fps:l,time:m,timeLineTime:F,timeLineProgress:o,timelineIndex:k,play:ca,reverse:ea,pause:aa,setOptions:fa,getOptions:ga};if(Array.isArray(a.to)){var H=[];a.from.forEach(function(b,c){var d=b+(a.to[c]-b)*a.easingFunction[c](h);H.push(d)}),b(H,G)}else{var I=a.from+(a.to-a.from)*a.easingFunction(h);b([I],G)}return 0===u&&1<=h&&T(y),U(o,F),B||z?void cancelAnimationFrame(q):void(c-r>=a.duration?X():q=requestAnimationFrame(W))},X=function(b,c){return b?void(F?"alternate"===a.direction?_(c):$(c):"alternate"===a.direction?$(c):_(c)):void("alternate"===a.direction&&1===v?(F?$():_(),v=2):"alternate-reverse"===a.direction&&1===v?(F?_():$(),v=2):(v=1,R()))},Y=function(d){if("string"==typeof d){var f=parseInt(d),g=J.reduce(function(a,b){return b.options.direction.includes("alternate")?a+2*b.options.duration:a+b.options.duration},0);d=Math.floor(f/100*g)}var h=0,j=L?J.length-1:0,k=L?0<=j&&j<J.length:j<J.length;for(j;k;j=L?j-1:j+1){var l=J[j];if(a=_objectSpread({},l.options),b=l.cb,L){var e=a.to;a.to=a.from,a.from=e,E=!0}if(u=a.repeat,I(a),K.add(l.id),h+=a.direction.includes("alternate")?2*a.duration:a.duration,a.direction.includes("alternate")){var m=c(h-d-2*a.duration);if(v=m>a.duration?2:1,r=performance.now(),s=c(2===v?m-a.duration:m),2===v&&!L){if(!E){var n=a.to;a.to=a.from,a.from=n,E=!0}}else if(2===v&&L&&E){var o=a.to;a.to=a.from,a.from=o,E=!1}}else r=performance.now(),s=c(h-d-a.duration);if(h>=d)break}W(r)},Z=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function b(a){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(cancelAnimationFrame(q),w=1===v,y=!1,t=1,s=0,void 0!==a&&0!==a&&"0%"!==a){b.next=8;break}return q=requestAnimationFrame(S),b.abrupt("return");case 8:Y(a),w=!1;case 10:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),$=function(b){if(E){var c=a.to;a.to=a.from,a.from=c,E=!1}Z(b)},_=function(b){if(!E){var c=a.to;a.to=a.from,a.from=c,E=!0}y=!1,Z(b)},aa=function(){B=!0,D=performance.now()},ba=function(){B?(B=!1,z=!1,O.clear(),r+=performance.now()-D,D=null,0<P.onStart.length&&P.onStart.forEach(function(a){return a.cb()}),q=requestAnimationFrame(W)):z?(B=!1,z=!1,0<P.onStart.length&&P.onStart.forEach(function(a){return a.cb()}),Z(A)):ca()},ca=function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function d(c){var e;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(z=!1,B=!1,F=!1,v=1,u=a.repeat,0===K.size&&(e=J[0],a=_objectSpread({},e.options),b=e.cb,I(a),u=a.repeat,K.add(e.id)),!a.delay){d.next=9;break}return d.next=9,o(a.delay);case 9:if(0<P.onStart.length&&1===K.size&&P.onStart.forEach(function(a){return a.cb()}),!a.direction.includes("reverse")){d.next=13;break}return _(c),d.abrupt("return");case 13:$(c);case 14:case"end":return d.stop();}},d)}));return function(){return c.apply(this,arguments)}}(),da=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d=arguments;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:b=0<d.length&&d[0]!==void 0?d[0]:"100%",c=!!(1<d.length&&d[1]!==void 0)&&d[1],c?ea(b):ca(b),cancelAnimationFrame(q),z=!0,A=b;case 6:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),ea=function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function d(c){var e;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(F=!0,L=!0,z=!1,B=!1,v=1,u=a.repeat,0===K.size&&(e=J[J.length-1],a=_objectSpread({},e.options),b=e.cb,I(a),u=a.repeat,K.add(e.id)),!a.delay){d.next=10;break}return d.next=10,o(a.delay);case 10:if(0<P.onStart.length&&1===K.size&&P.onStart.forEach(function(a){return a.cb()}),!a.direction.includes("reverse")){d.next=14;break}return $(c),d.abrupt("return");case 14:_(c);case 15:case"end":return d.stop();}},d)}));return function(){return c.apply(this,arguments)}}(),fa=function(b){var d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0;if(e>J.length-1)return void(isDevMode&&console.warn("[setOptions] Index param is out of range"));if(0<e){var f=J[e-1],g=f.options.direction.includes("alternate")?2*f.options.duration:f.options.duration;"string"==typeof b.duration&&(b.duration=c(g+parseInt(b.duration))),"string"==typeof b.delay&&(b.delay=c(f.options.delay+parseInt(b.delay)))}var h=J[e].options,j=h.direction.includes("alternate"),k=null===(d=b.direction)||void 0===d?void 0:d.includes("alternate"),l="number"==typeof b.duration,m="undefined"!=typeof b.easing,o=void 0!==b.from,p=void 0!==b.to,q=K.size-1===e||0===K.size&&0===e,s=J[e+1];if(s){p&&void 0===s.userInput.from&&(s.options.from=b.to);for(var w=e+1;w<J.length;w++){var t,v=J[w];m&&void 0===v.userInput.easingFunction&&(v.options.easingFunction=b.easingFunction),l&&void 0===v.userInput.duration&&(v.options.duration=null!==(t=v.options.direction)&&void 0!==t&&t.includes("alternate")?b.duration/2:b.duration)}}if(b.direction?k&&!j?(l?b.duration/=2:J[e].options.duration/=2,a.duration=q?a.duration/2:a.duration):!k&&j&&(l?b.duration*=2:J[e].options.duration*=2,a.duration=q?2*a.duration:a.duration):l&&(b.duration=j?b.duration/2:b.duration),q){l&&(r=B?D-b.duration*((D-r)/a.duration):performance.now()-b.duration*((performance.now()-r)/a.duration)),"number"==typeof b.repeat&&(u=b.repeat),void 0===a.from&&p&&!o&&(a.from=Array.isArray(b.to)?Array(b.to.length).fill(0):0);var i={};p&&o&&E?(i.to=b.from,i.from=b.to):p&&!o&&E?i.from=b.to:!p&&o&&E&&(i.to=b.from),a=_objectSpread(_objectSpread(_objectSpread({},a),b),i),isDevMode&&n(),b.easingFunction&&I(b)}J[e].options=_objectSpread(_objectSpread({},h),b),J[e].userInput=_objectSpread(_objectSpread({},J[e].userInput),b)},ga=function(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:0;return a>J.length-1?void(isDevMode&&console.warn("[getOptions] Index param is out of range")):J[a].options},ha=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;if("number"!=typeof a&&"string"!=typeof a||"number"!=typeof b){if(isDevMode)throw new Error("[asyncOnProgress] first param must be a number or string, the second param must be a number");return}return H?void 0:new Promise(function(c){H={at:a,atRepeat:b,resolve:c}})},ia=function(){return G?void 0:new Promise(function(a){G=a})},ja=function(a){if("object"!==_typeof(a)){if(isDevMode)throw new Error("[setTimeLineOptions] param must be an object");return}a.repeat!==void 0&&(N=a.repeat),a.speed!==void 0&&J.forEach(function(b){b.options.duration=0>a.speed?b.options.duration*-a.speed:b.options.duration/a.speed}),M=_objectSpread(_objectSpread({},M),a)};a.autoPlay&&ca();var ka={play:ca,reverse:ea,stop:da,pause:aa,resume:ba,onStart:function onStart(a){if("function"!=typeof a){if(isDevMode)throw new Error("[onStart] param must be a callback function");return}var b="onStart_".concat(100*Math.random());return P.onStart.push({cb:a,id:b}),function(){P.onStart=P.onStart.filter(function(a){return a.id!==b})}},onFinish:function onFinish(a){if("function"!=typeof a){if(isDevMode)throw new Error("[onFinish] accept a callback function only");return}var b="onFinish_".concat(100*Math.random());return P.onFinish.push({cb:a,id:b}),function(){P.onFinish=P.onFinish.filter(function(a){return a.id!==b})}},asyncOnFinish:ia,onProgress:function onProgress(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;if("number"!=typeof a&&"string"!=typeof a||"function"!=typeof b||"number"!=typeof c){if(isDevMode)throw new Error("[onProgress] first param must be a number or string, second param must be a callback function, third param must be a number");return}var d="onProgress_".concat(100*Math.random());return P.onProgress.push({at:a,cb:b,atRepeat:c,id:d}),function(){P.onProgress=P.onProgress.filter(function(a){return a.id!==d})}},asyncOnProgress:ha,setOptions:fa,getOptions:ga,next:function next(a,b){var d,e,f,g,h,i,j,k,l,m=_objectSpread({},a),n=J[J.length-1];a.from=null!==(d=a.from)&&void 0!==d?d:n.options.to,a.direction=null!==(e=a.direction)&&void 0!==e?e:"normal",a.easingFunction=null!==(f=a.easingFunction)&&void 0!==f?f:n.options.easingFunction,a.delay=null!==(g=a.delay)&&void 0!==g?g:0,a.repeat=null!==(h=a.repeat)&&void 0!==h?h:0,b=null!==(i=b)&&void 0!==i?i:n.cb,a.autoPlay=!1;var o=n.options.direction.includes("alternate")?2*n.options.duration:n.options.duration;"string"==typeof a.duration&&(a.duration=c(o+parseInt(a.duration))),"string"==typeof a.delay&&(a.delay=c(n.options.delay+parseInt(a.delay)));var p=null===(j=n.options)||void 0===j?void 0:j.direction.includes("alternate"),q=null===(k=a.direction)||void 0===k?void 0:k.includes("alternate"),r="number"==typeof a.duration;return r&&q?a.duration/=2:!r&&q&&p?a.duration=n.options.duration:r||q||!p?r||!q||p?a.duration=null!==(l=a.duration)&&void 0!==l?l:n.options.duration:a.duration=n.options.duration/2:a.duration=2*n.options.duration,J.push({options:a,cb:b,id:"to".concat(100*Math.random()),userInput:m}),_objectSpread(_objectSpread({},ka),{},{setTimeLineOptions:ja})}};return ka}