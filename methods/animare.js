"use strict";var _easingFunctions=require("./easingFunctions");Object.defineProperty(exports,"__esModule",{value:!0}),exports.animare=animare;function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var isDevMode=!process.env.NODE_ENV||"development"===process.env.NODE_ENV;function animare(a,b){var c=Math.abs;var d,e,f,g,h,i,j;a=null!==(d=a)&&void 0!==d?d:{},a.duration=null!==(e=a.duration)&&void 0!==e?e:350,a.autoPlay=null===(f=a.autoPlay)||void 0===f||f,a.repeat=null!==(g=a.repeat)&&void 0!==g?g:0,a.delay=null!==(h=a.delay)&&void 0!==h?h:0,a.direction=null!==(i=a.direction)&&void 0!==i?i:"normal",a.easingFunction=null!==(j=a.easingFunction)&&void 0!==j?j:_easingFunctions.easing.linear;var k=function(){if("number"!=typeof a.to&&!Array.isArray(a.to))throw new Error("[to] is required");if(Array.isArray(a.to)){if(!a.to.every(function(a){return"number"==typeof a}))throw new Error("[to] must be a number or an array of numbers");}else if("number"!=typeof a.to)throw new Error("[to] must be a number or an array of numbers");if(Array.isArray(a.from)){if(!a.from.every(function(a){return"number"==typeof a}))throw new Error("[from] must be a number or an array of numbers");if(a.from.length!==a.to.length)throw new Error("[from] and [to] must have the same length")}else if(a.from&&"number"!=typeof a.from)throw new Error("[from] must be a number or an array of numbers");if("number"!=typeof a.duration||0>a.duration)throw new Error("[duration] must be a number greater than -1");if("number"!=typeof a.delay||0>a.delay)throw new Error("[delay] must be a number greater than -1");if("number"!=typeof a.repeat)throw new Error("[repeat] must be a number");if("boolean"!=typeof a.autoPlay)throw new Error("[autoPlay] must be a boolean");if(!["normal","reverse","alternate","alternate-reverse"].includes(a.direction))throw new Error("[direction] must be a string and one of the following: normal, reverse, alternate, alternate-reverse");if("string"==typeof a.easingFunction&&!_easingFunctions.easing.hasOwnProperty(a.easingFunction))throw new Error("[easingFunction] must be a string, array of strings, function or array of functions, and for a string value one of the following: "+Object.keys(_easingFunctions.easing).join(", "));Array.isArray(a.easingFunction)&&a.easingFunction.forEach(function(a){if("string"==typeof a&&!_easingFunctions.easing.hasOwnProperty(a))throw new Error("[easingFunction] must be a string, array of strings, function or array of functions, and for a string value one of the following: "+Object.keys(_easingFunctions.easing).join(", "))})};isDevMode&&k(),a.direction.includes("alternate")&&(a.duration/=2);var l=function(a){return new Promise(function(b){return setTimeout(b,a)})},m=null,n=0,o=1,q=a.repeat,r=1,s=!0,t=!1,u=!1,v=!0,w=null,y=!1,z=!1,A=null,B=!1,C=!1,D=!1,E=null,F=null;a.from===void 0&&(a.from=Array.isArray(a.to)?Array(a.to.length).fill(0):0);var G=function(b){var c=b.easingFunction,d=Array.isArray(c),e="function"==typeof c,f=Array.isArray(a.to);d&&f?(a.easingFunction=c.map(function(a){return"string"==typeof a?_easingFunctions.easing[a]:a}),c.length<a.to.length&&(a.easingFunction=c.concat(Array(a.to.length-c.length).fill(_easingFunctions.easing.linear))),a.to.length>c.length&&(c.length=a.to.length)):d&&!f?a.easingFunction="string"==typeof c[0]?_easingFunctions.easing[c[0]]:c[0]:!d&&f?e?a.easingFunction=Array(a.to.length).fill(c):"string"==typeof c&&(a.easingFunction=Array(a.to.length).fill(_easingFunctions.easing[c])):!d&&!f&&(a.easingFunction=e?c:_easingFunctions.easing[c])};G(a);var H=[{options:_objectSpread({},a),cb:b,id:"default"}],I=new Set,J=!1,K={repeat:0,speed:1},L=K.repeat,M=new Set,N={onProgress:[],onStart:[],onFinish:[]},O=function(){if(!(v||y)){if(I.size===H.length)return(I.clear(),M.clear(),C=!1,a=_objectSpread({},H[0].options),b=H[0].cb,0===L)?(L=K.repeat,void(J=!1)):(L=0>L?-1:L-1,void(J?ba():_()));if(J){for(var c,d=H.length-1;0<=d&&d<H.length;d--)if(c=H[d],!I.has(c.id)){a=_objectSpread({},c.options),b=c.cb,q=a.repeat,G(a),I.add(c.id),C=!1,ba();break}return}for(var e,f=0;f<H.length;f++)if(e=H[f],!I.has(e.id)){a=_objectSpread({},e.options),b=e.cb,q=a.repeat,G(a),I.add(e.id),C=!1,_();break}}},P=function(){var b=_asyncToGenerator(regeneratorRuntime.mark(function b(){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(0!==a.repeat){b.next=3;break}return O(),b.abrupt("return");case 3:if(0!==q){b.next=8;break}return q=a.repeat,D=!1,O(),b.abrupt("return");case 8:if(0>q&&M.clear(),q=0>q?-1:q-1,!a.delay){b.next=13;break}return b.next=13,l(a.delay);case 13:if(!a.direction.includes("alternate")){b.next=16;break}return U(!0),b.abrupt("return");case 16:C?Y():X();case 17:case"end":return b.stop();}},b)}));return function(){return b.apply(this,arguments)}}(),Q=function(a){2!==r&&(s=!0),m=a,T(a,!0),s=!1},R=function(a){I.size!==H.length||(u=!1,E&&a&&(E(),E=null),0<N.onFinish.length&&N.onFinish.forEach(function(b){var c=b.cb;a&&c()}))},S=function(a,b){if(F){var c=F,d=c.at,e=c.resolve,f=c.atRepeat;if("string"==typeof d){var g=parseInt(d);a>=g&&f===q&&!M.has(a)&&(M.add(a),e(),F=null)}b>=d&&!M.has(b)&&(M.add(b),e(),F=null)}0<N.onProgress.length&&N.onProgress.forEach(function(c){var d=c.at,e=c.cb,f=c.id,g=c.atRepeat;if("string"==typeof d){var h=parseInt(d);a>=h&&g===q&&!M.has(f)&&(e(),M.add(f))}b>=d&&!M.has(f)&&(e(),M.add(f))})},T=function(c){var f=Math.max,g=Math.min,h=Math.round;c+=n;var j=(c-m)/a.duration;j=1<=j?1:j,u=!0;var k=h(o/((performance.now()-m)/1e3));o+=1;var l=c-m>a.duration?a.duration:h(c-m);l=a.direction.includes("alternate")&&2===r?l+a.duration:l;var w=a.direction.includes("alternate")?1===r?j/2:j/2+.5:j;w=f(0,g(100,h(100*w)));var A=w/H.length+100*((I.size-1)/H.length);A=f(0,g(100,h(A)));for(var C,D=0,E=0;E<I.size-1;E++)C=H[E].options.duration,D=1===I.size?0:D+C;var F=D+l;1<=j&&(t=!a.direction.includes("alternate")||2===r),z=0===q&&1<=j&&t&&I.size===H.length;var G={isFirstFrame:s,isLastFrame:t,isFinished:z,progress:w,repeatCount:q,alternateCycle:r,fps:k,time:l,timeLineTime:F,timeLineProgress:A,play:_,reverse:ba,pause:Z,stop:aa,setOptions:ca,getOptions:da};if(Array.isArray(a.to)){var J=[];a.from.forEach(function(b,c){var d=b+(a.to[c]-b)*a.easingFunction[c](j);J.push(d)}),b(J,G)}else{var K=a.from+(a.to-a.from)*a.easingFunction(j);b([K],G)}0===q&&1<=j&&R(t),S(A,F);y||v||B||(c-m>=a.duration?U():requestAnimationFrame(T))},U=function(b,c){return b?void(D?"alternate"===a.direction?Y(c):X(c):"alternate"===a.direction?X(c):Y(c)):void("alternate"===a.direction&&1===r?(D?X():Y(),r=2):"alternate-reverse"===a.direction&&1===r?(D?Y():X(),r=2):(r=1,P()))},V=function(d){if("string"==typeof d){var f=parseInt(d),g=H.reduce(function(a,b){return b.options.direction.includes("alternate")?a+2*b.options.duration:a+b.options.duration},0);d=Math.floor(f/100*g)}var h=0,j=J?H.length-1:0,k=J?0<=j&&j<H.length:j<H.length;for(j;k;j=J?j-1:j+1){var l=H[j];if(a=_objectSpread({},l.options),b=l.cb,J){var e=a.to;a.to=a.from,a.from=e,C=!0}if(q=a.repeat,G(a),I.add(l.id),h+=a.direction.includes("alternate")?2*a.duration:a.duration,a.direction.includes("alternate")){var o=c(h-d-2*a.duration);if(r=o>a.duration?2:1,m=performance.now(),n=c(2===r?o-a.duration:o),2===r&&!J){if(!C){var p=a.to;a.to=a.from,a.from=p,C=!0}}else if(2===r&&J&&C){var s=a.to;a.to=a.from,a.from=s,C=!1}}else m=performance.now(),n=c(h-d-a.duration);if(h>=d)break}T(m)},W=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function b(a){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:if(B=!0,!u){b.next=4;break}return b.next=4,l(8);case 4:if(B=!1,s=1===r,t=!1,o=1,n=0,void 0!==a&&0!==a&&"0%"!==a){b.next=12;break}return requestAnimationFrame(Q),b.abrupt("return");case 12:V(a),s=!1;case 14:case"end":return b.stop();}},b)}));return function(){return a.apply(this,arguments)}}(),X=function(b){if(C){var c=a.to;a.to=a.from,a.from=c,C=!1}W(b)},Y=function(b){if(!C){var c=a.to;a.to=a.from,a.from=c,C=!0}t=!1,W(b)},Z=function(){y=!0,u=!1,A=performance.now()},$=function(){y?(y=!1,v=!1,M.clear(),m+=performance.now()-A,A=null,0<N.onStart.length&&N.onStart.forEach(function(a){return a.cb()}),requestAnimationFrame(T)):v?(y=!1,v=!1,0<N.onStart.length&&N.onStart.forEach(function(a){return a.cb()}),W(w)):_()},_=function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function d(c){var e;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(v=!1,y=!1,D=!1,r=1,q=a.repeat,0===I.size&&(e=H[0],a=_objectSpread({},e.options),b=e.cb,G(a),q=a.repeat,I.add(e.id)),!a.delay){d.next=9;break}return d.next=9,l(a.delay);case 9:if(0<N.onStart.length&&1===I.size&&N.onStart.forEach(function(a){return a.cb()}),!a.direction.includes("reverse")){d.next=13;break}return Y(c),d.abrupt("return");case 13:X(c);case 14:case"end":return d.stop();}},d)}));return function(){return c.apply(this,arguments)}}(),aa=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d=arguments;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(b=0<d.length&&void 0!==d[0]?d[0]:"100%",c=!!(1<d.length&&void 0!==d[1])&&d[1],!v){a.next=4;break}return a.abrupt("return");case 4:c?ba(b):_(b),v=!0,u=!1,w=b;case 8:case"end":return a.stop();}},a)}));return function(){return a.apply(this,arguments)}}(),ba=function(){var c=_asyncToGenerator(regeneratorRuntime.mark(function d(c){var e;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:if(D=!0,J=!0,v=!1,y=!1,r=1,q=a.repeat,0===I.size&&(e=H[H.length-1],a=_objectSpread({},e.options),b=e.cb,G(a),q=a.repeat,I.add(e.id)),!a.delay){d.next=10;break}return d.next=10,l(a.delay);case 10:if(0<N.onStart.length&&1===I.size&&N.onStart.forEach(function(a){return a.cb()}),!a.direction.includes("reverse")){d.next=14;break}return X(c),d.abrupt("return");case 14:Y(c);case 15:case"end":return d.stop();}},d)}));return function(){return c.apply(this,arguments)}}(),ca=function(b){var c,d,e,f=a.direction.includes("alternate"),g=null===(c=b.direction)||void 0===c?void 0:c.includes("alternate"),h="number"==typeof b.duration,i=void 0!==b.from,j=void 0!==b.to;if(b.direction?g&&!f?h?b.duration/=2:a.duration/=2:!g&&f&&(h?b.duration*=2:a.duration*=2):h&&(b.duration=f?b.duration/2:b.duration),h&&(m=y?A-b.duration*((A-m)/a.duration):performance.now()-b.duration*((performance.now()-m)/a.duration)),"number"==typeof b.repeat&&(q=b.repeat),void 0===a.from&&j&&!i&&(a.from=Array.isArray(b.to)?Array(b.to.length).fill(0):0),j&&i&&C){var l=b.to;b.to=b.from,b.from=l}else j&&!i&&C?(b.from=b.to,delete b.to):!j&&i&&C&&(b.to=b.from,delete b.from);j&&void 0!==(null===H||void 0===H||null===(d=H[0])||void 0===d||null===(e=d.options)||void 0===e?void 0:e.from)&&(H[0].options.from=b.to),a=_objectSpread(_objectSpread({},a),b),H[0].options=_objectSpread({},a),isDevMode&&k(),b.easingFunction&&G(b)},da=function(){return a},ea=function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:0;if("number"!=typeof a&&"string"!=typeof a||"number"!=typeof b){if(isDevMode)throw new Error("[asyncOnProgress] first param must be a number or string, the second param must be a number");return}return F?void 0:new Promise(function(c){F={at:a,atRepeat:b,resolve:c}})},fa=function(){return E?void 0:new Promise(function(a){E=a})},ga=function(a){if("object"!==_typeof(a)){if(isDevMode)throw new Error("[setTimeLineOptions] param must be an object");return}a.repeat!==void 0&&(L=a.repeat),a.speed!==void 0&&H.forEach(function(b){b.options.duration=0>a.speed?b.options.duration*-a.speed:b.options.duration/a.speed}),K=_objectSpread(_objectSpread({},K),a)};a.autoPlay&&_();var ha={play:_,reverse:ba,stop:aa,pause:Z,resume:$,onStart:function onStart(a){if("function"!=typeof a){if(isDevMode)throw new Error("[onStart] param must be a callback function");return}var b="onStart_".concat(100*Math.random());return N.onStart.push({cb:a,id:b}),function(){N.onStart=N.onStart.filter(function(a){return a.id!==b})}},onFinish:function onFinish(a){if("function"!=typeof a){if(isDevMode)throw new Error("[onFinish] accept a callback function only");return}var b="onFinish_".concat(100*Math.random());return N.onFinish.push({cb:a,id:b}),function(){N.onFinish=N.onFinish.filter(function(a){return a.id!==b})}},asyncOnFinish:fa,onProgress:function onProgress(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:0;if("number"!=typeof a&&"string"!=typeof a||"function"!=typeof b||"number"!=typeof c){if(isDevMode)throw new Error("[onProgress] first param must be a number or string, second param must be a callback function, third param must be a number");return}var d="onProgress_".concat(100*Math.random());return N.onProgress.push({at:a,cb:b,atRepeat:c,id:d}),function(){N.onProgress=N.onProgress.filter(function(a){return a.id!==d})}},asyncOnProgress:ea,setOptions:ca,getOptions:da,next:function next(a,b){var d,e,f,g,h,i,j,k,l,m=H[H.length-1];a.from=null!==(d=a.from)&&void 0!==d?d:m.options.to,a.direction=null!==(e=a.direction)&&void 0!==e?e:"normal",a.easingFunction=null!==(f=a.easingFunction)&&void 0!==f?f:m.options.easingFunction,a.delay=null!==(g=a.delay)&&void 0!==g?g:0,a.repeat=null!==(h=a.repeat)&&void 0!==h?h:0,b=null!==(i=b)&&void 0!==i?i:m.cb,a.duration="string"==typeof a.duration?c(m.options.duration+parseInt(a.duration)):a.duration,a.delay="string"==typeof a.delay?c(m.options.delay+parseInt(a.delay)):a.delay;var n=null===(j=m.options)||void 0===j?void 0:j.direction.includes("alternate"),o=null===(k=a.direction)||void 0===k?void 0:k.includes("alternate"),p="number"==typeof a.duration;return p&&o?a.duration/=2:!p&&o&&n?a.duration=m.options.duration:p||o||!n?p||!o||n?a.duration=null!==(l=a.duration)&&void 0!==l?l:m.options.duration:a.duration=m.options.duration/2:a.duration=2*m.options.duration,H.push({options:a,cb:b,id:"to".concat(100*Math.random())}),_objectSpread(_objectSpread({},ha),{},{setTimeLineOptions:ga})}};return ha}